<Project ToolsVersion="14.0"
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_XrmFrameworkTaskDir Condition=" '$(_XrmFrameworkTaskDir)'=='' ">$(MSBuildThisFileDirectory)tasks</_XrmFrameworkTaskDir>
    <_XrmFrameworkLoggedServiceGenerator Condition=" '$(_XrmFrameworkTaskAssemblyFullPath)'=='' ">$(_XrmFrameworkTaskDir)\XrmFramework.MSBuild.Reflection.exe</_XrmFrameworkLoggedServiceGenerator>
  </PropertyGroup>


  <Target Name="RestoreServicesProject" AfterTargets="Restore">

    <PropertyGroup>
      <ProjectFolderPath>$([System.IO.Directory]::GetParent($(MSBuildProjectFullPath)))</ProjectFolderPath>
    </PropertyGroup>

    <ItemGroup>
      <FilesToCopy Include="$(MSBuildThisFileDirectory)\..\ServicesProject\**" />
    </ItemGroup>

    <Copy SourceFiles="@(FilesToCopy)" DestinationFiles="@(FilesToCopy->'$(ProjectFolderPath)\bin\ServicesProject\%(RecursiveDir)%(Filename)%(Extension)')" />

    <PropertyGroup>
      <ProjectFile>$(ProjectFolderPath)\bin\ServicesProject\ServicesProject.csproj</ProjectFile>
    </PropertyGroup>

    <MSBuild Projects="$(ProjectFile)" Targets="Restore" Properties="Configuration=$(Configuration);XrmFrameworkDisableSubBuild=True;SolutionDir=$(SolutionDir);XrmFrameworkIsPluginProject=$(XrmFrameworkIsPluginProject);XrmFrameworkDisableLoggedServiceGeneration=true" ContinueOnError="true" />

  </Target>

  <Target Name="GenerateLoggedServices" BeforeTargets="Compile" Condition="'$(XrmFrameworkDisableLoggedServiceGeneration)' == ''">
    <Message Importance="High" Text="Building ServicesProject" />

    <PropertyGroup>
      <ProjectFolderPath>$([System.IO.Directory]::GetParent($(MSBuildProjectFullPath)))</ProjectFolderPath>
    </PropertyGroup>

    <ItemGroup>
      <LoggedFilesToDelete Include="**\Logged*.cs" />
    </ItemGroup>

    <ItemGroup Condition="'$(MSBuildLastTaskResult)' == 'False'">
      <Compile Remove="**\Logged*.cs" />
    </ItemGroup>

    <Delete Files="@(LoggedFilesToDelete)" ContinueOnError="true" />

    <PropertyGroup>
      <ProjectFile>$(ProjectFolderPath)\bin\ServicesProject\ServicesProject.csproj</ProjectFile>
      <ProjectOutputFile>$(ProjectFolderPath)\bin\ServicesProject\bin\$(Configuration)\netcoreapp3.1\ServicesProject.dll</ProjectOutputFile>
    </PropertyGroup>
    <Message Importance="High" Text="=============> ProjectOutputFile=$(ProjectOutputFile)" />

    <MSBuild Projects="$(ProjectFile)" Targets="Build" Properties="Configuration=$(Configuration);XrmFrameworkDisableSubBuild=True;SolutionDir=$(SolutionDir);XrmFrameworkIsPluginProject=$(XrmFrameworkIsPluginProject);XrmFrameworkDisableLoggedServiceGeneration=true" ContinueOnError="false" />

    <Exec 
      Command="dotnet run $(_XrmFrameworkLoggedServiceGenerator) -- $(ProjectOutputFile)"
      Condition="'$(MSBuildLastTaskResult)' == 'True'"
      YieldDuringToolExecution="true"
      StandardErrorImportance="High" />

    <ItemGroup Condition="'$(MSBuildLastTaskResult)' == 'True'">
      <Compile Include="**\Logged*.cs" />
    </ItemGroup>

  </Target>

</Project>